@model TechShop.Models.ShoppingCart

<style>
    .stock-warning {
        font-weight: 500;
        margin-top: 5px;
    }

    #message {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-lg {
        padding: 12px 24px;
        font-size: 1.125rem;
    }

    .table td {
        vertical-align: middle;
    }

    .form-control-sm {
        max-width: 80px;
    }
</style>

<div class="container py-4">
    <h2 class="mb-4">Ваш кошик</h2>

    <div id="message" class="alert" style="display: none;"></div>

    @if (Model.Items.Any())
    {
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Товар</th>
                <th>Ціна</th>
                <th>Кількість</th>
                <th>Сума</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in Model.Items)
            {
            var subtotal = Math.Round(item.Quantity * item.Product.Price, 2);
            <tr>
                <td>@item.Product.Name</td>
                <td>@item.Product.Price.ToString("F2") ₴</td>
                <td>
                    <input type="number" id="quantity-@item.ProductId" value="@item.Quantity" min="1" max="@item.Product.StockQuantity" class="form-control form-control-sm" />
                </td>
                <td id="subtotal-@item.ProductId">@subtotal.ToString("F2") ₴</td>
                <td>
                    <form asp-action="RemoveFromCart" method="post">
                        <input type="hidden" name="productId" value="@item.ProductId" />
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            }
            </tbody>
        </table>
    </div>

    <p id="total" class="h4 text-end mb-4">
        Всього: <span class="text-primary">@Math.Round(Model.Items.Sum(i => i.Quantity * i.Product.Price), 2).ToString("F2") ₴</span>
    </p>

    <form id="checkoutForm" asp-action="Checkout" method="post" class="text-end">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-shopping-cart me-2"></i>Купити зараз
        </button>
    </form>
    }
    else
    {
    <div class="alert alert-info">
        Ваш кошик порожній.
    </div>
    }
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // Оновлення кількості товару
        $('input[type="number"]').on('change', function () {
            var productId = $(this).attr('id').split('-')[1];
            var quantity = $(this).val();
            var maxQuantity = $(this).attr('max');

            // Перевіряємо чи не перевищує користувач максимальну кількість
            if (parseInt(quantity) > parseInt(maxQuantity)) {
                showToast(`Максимальна доступна кількість: ${maxQuantity} шт.`, 'error');
                $(this).val(maxQuantity);
                quantity = maxQuantity;
            }

            if (parseInt(quantity) < 1) {
                $(this).val(1);
                quantity = 1;
            }

            $.ajax({
                url: '@Url.Action("UpdateQuantity", "ShoppingCart")',
                type: 'POST',
                data: { productId: productId, quantity: quantity },
                success: function (result) {
                    if (result.success) {
                        $('#subtotal-' + productId).text(result.subtotal.toFixed(2) + ' ₴');
                        $('#total span').text(result.total.toFixed(2) + ' ₴');

                        // Приховуємо повідомлення про помилку якщо воно було
                        $('#message').hide();
                    } else {
                        showToast(result.message, 'error');
                        // Повертаємо попереднє значення при помилці
                        location.reload();
                    }
                },
                error: function () {
                    showToast('Помилка оновлення кількості. Спробуйте ще раз.', 'error');
                    location.reload();
                }
            });
        });

        $('#checkoutForm').on('submit', function (e) {
            e.preventDefault();

            $('#message')
                .removeClass('alert-success alert-danger')
                .addClass('alert-info')
                .html('<i class="fas fa-spinner fa-spin me-2"></i>Перевірка наявності товарів...')
                .show();

            var submitButton = $(this).find('button[type="submit"]');
            var originalButtonText = submitButton.html();
            submitButton.prop('disabled', true)
                .html('<span class="spinner-border spinner-border-sm me-2" role="status"></span>Перевіряємо...');

            $.ajax({
                url: this.action,
                type: 'POST',
                success: function (result) {
                    if (result.success) {
                        $('#message')
                            .removeClass('alert-info alert-danger')
                            .addClass('alert-success')
                            .html('<i class="fas fa-check-circle me-2"></i>Все гаразд! Перенаправлення на оформлення замовлення...')
                            .show();

                        setTimeout(function() {
                            window.location.href = result.redirect;
                        }, 1000);
                    } else {
                        $('#message')
                            .removeClass('alert-info alert-success')
                            .addClass('alert-danger')
                            .html('<i class="fas fa-exclamation-triangle me-2"></i>' + result.message)
                            .show();

                        submitButton.prop('disabled', false).html(originalButtonText);

                        if (result.hasStockIssues) {
                            highlightStockIssues();

                            showToast('Перевірте кількість товарів у кошику', 'error');
                        }
                    }
                },
                error: function () {
                    $('#message')
                        .removeClass('alert-info alert-success')
                        .addClass('alert-danger')
                        .html('<i class="fas fa-times-circle me-2"></i>Виникла помилка при перевірці замовлення. Спробуйте пізніше.')
                        .show();

                    submitButton.prop('disabled', false).html(originalButtonText);
                }
            });
        });

        function highlightStockIssues() {
            $('input[type="number"]').each(function() {
                var currentQuantity = parseInt($(this).val());
                var maxQuantity = parseInt($(this).attr('max'));

                if (currentQuantity > maxQuantity || maxQuantity === 0) {
                    $(this).closest('tr').addClass('table-danger').addClass('border-danger');

                    if (!$(this).closest('td').find('.stock-warning').length) {
                        $(this).closest('td').append('<small class="text-danger stock-warning d-block">Перевищено наявність!</small>');
                    }
                } else {
                    $(this).closest('tr').removeClass('table-danger').removeClass('border-danger');
                    $(this).closest('td').find('.stock-warning').remove();
                }
            });
        }

        function showToast(message, type) {
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: message,
                    duration: 4000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: type === 'error' ? "#dc3545" : "#28a745"
                    }
                }).showToast();
            } else {
                alert(message);
            }
        }

        highlightStockIssues();
    });
</script>